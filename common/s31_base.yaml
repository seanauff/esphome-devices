# https://www.esphome-devices.com/devices/Sonoff-S31

logger:
  baud_rate: 0 # (UART logging interferes with cse7766)

uart:
  rx_pin: RX
  baud_rate: 4800

status_led:
  pin: GPIO13

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: True
    id: button
    on_press:
      - switch.toggle: relay

switch:
  - platform: gpio
    name: ${name} Relay
    pin: GPIO12
    id: relay
    icon: "mdi:power-plug"
    restore_mode: RESTORE_DEFAULT_ON
    # on-plug action to power cycle the connected device
  - platform: template
    name: ${name} Restart Connected
    id: restart_connected
    disabled_by_default: True
    icon: "mdi:restart-alert"
    #optimistic: True
    #assumed_state: True
    turn_on_action:
      then: 
        - switch.template.publish:
            id: restart_connected
            state: ON
        - switch.turn_off: relay
        - delay: 10s
        - switch.turn_on: relay
        - switch.template.publish:
            id: restart_connected
            state: OFF

sensor:
  - platform: cse7766
    update_interval: 10s
    current:
      name: ${name} Current
      accuracy_decimals: 2
    voltage:
      name: "${name} Voltage"
      accuracy_decimals: 1
    power:
      icon: "mdi:flash-circle"
      name: ${name} Power
      accuracy_decimals: 2
      filters:
        - lambda:
            if (id(relay).state) {
              return x;   
            } else {
              return 0;
            }
